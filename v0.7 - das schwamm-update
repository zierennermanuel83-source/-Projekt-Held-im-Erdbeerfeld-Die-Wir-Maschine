import pygame
import random
import math
import os

# ==========================================
# PROJEKT: HELD IM ERDBEERFELD (Die Wir-Maschine)
# VERSION: 0.7 - "Der wellumin√∂se Schwamm"
# VISION: Optimismus ist ein Muskel.
# ==========================================

WIDTH, HEIGHT = 800, 600
FPS = 60

# Farben
STRAWBERRY_RED = (220, 20, 60)
HAPPY_BLUE = (30, 144, 255)
CHAOS_GREY = (60, 60, 70)
RADIANT_GOLD = (255, 225, 100)
SPONGE_YELLOW = (255, 255, 50)
DARK_SPACE = (5, 5, 12)

pygame.init()
screen = pygame.display.set_mode((WIDTH, HEIGHT))
pygame.display.set_caption("üçì Wir-Maschine v0.7 - Optimismus-Schwamm")
clock = pygame.time.Clock()
font_ui = pygame.font.SysFont("Arial", 18, bold=True)

# --- Speicher ---
SCORE_FILE = "resonanz_bilanz.txt"
def lade_bilanz():
    if os.path.exists(SCORE_FILE):
        with open(SCORE_FILE, "r") as f:
            try: return int(f.read())
            except: return 0
    return 0

class ResonanzWelle:
    def __init__(self, x, y, color, speed=6, max_r=400):
        self.x, self.y = x, y
        self.radius = 0
        self.max_radius = max_r
        self.alpha = 255
        self.color = color
        self.speed = speed
        self.alive = True

    def update(self):
        self.radius += self.speed
        self.alpha -= (255 / (self.max_radius / self.speed))
        if self.alpha <= 0: self.alive = False

    def draw(self, surface):
        if self.alive and self.alpha > 0:
            s = pygame.Surface((int(self.radius*2), int(self.radius*2)), pygame.SRCALPHA)
            pygame.draw.circle(s, (*self.color, int(self.alpha)), (int(self.radius), int(self.radius)), int(self.radius), width=3)
            surface.blit(s, (self.x - self.radius, self.y - self.radius))

class SpongeHelper:
    def __init__(self):
        self.active = False
        self.timer = 0
        self.x, self.y = WIDTH//2, HEIGHT//2
        self.w, self.h = 60, 80

    def activate(self):
        self.active = True
        self.timer = 300 # 5 Sekunden bei 60 FPS

    def update(self, particles):
        if self.active:
            self.timer -= 1
            # Wackel-Bewegung
            self.x = WIDTH//2 + math.sin(pygame.time.get_ticks()*0.01)*100
            self.y = HEIGHT//2 + math.cos(pygame.time.get_ticks()*0.01)*50
            # Chaos aufsaugen
            for p in particles[:]:
                if math.hypot(self.x - p['x'], self.y - p['y']) < 100:
                    particles.remove(p)
            if self.timer <= 0: self.active = False

    def draw(self, surface):
        if self.active:
            # Der gelbe "Tribut"-Schwamm
            rect = pygame.Rect(self.x-30, self.y-40, 60, 80)
            pygame.draw.rect(surface, SPONGE_YELLOW, rect, border_radius=5)
            # Poren zeichnen
            for i in range(5):
                px = self.x - 20 + (i*10)
                py = self.y - 30 + (i*15) % 60
                pygame.draw.circle(surface, (200, 200, 0), (px, py), 5)

def main():
    running = True
    total_awakened = lade_bilanz()
    mission_goal = 5
    mission_progress = 0
    
    my_core = {'x': WIDTH//2, 'y': HEIGHT//2, 'r': 45, 'shield': 0, 'pulse': 0}
    partners = [{'x': random.randint(50, 750), 'y': random.randint(50, 550), 'e': 0, 'a': False} for _ in range(12)]
    particles = []
    wellen = []
    sponge = SpongeHelper()
    
    while running:
        for event in pygame.event.get():
            if event.type == pygame.QUIT: running = False
            # TOUCH ODER MAUSKLICK ODER LEERTASTE
            if event.type in [pygame.MOUSEBUTTONDOWN, pygame.KEYDOWN]:
                my_core['shield'] = min(100, my_core['shield'] + 25)
                wellen.append(ResonanzWelle(my_core['x'], my_core['y'], HAPPY_BLUE, speed=10))

        if random.random() < 0.05:
            particles.append({'x': random.choice([-20, 820]), 'y': random.randint(0, 600), 'speed': random.uniform(2, 5)})
        
        screen.fill(DARK_SPACE)
        my_core['pulse'] += 0.05
        if my_core['shield'] > 0: my_core['shield'] -= 0.8
        
        # Mission erf√ºllt?
        if mission_progress >= mission_goal:
            sponge.activate()
            wellen.append(ResonanzWelle(WIDTH//2, HEIGHT//2, RADIANT_GOLD, speed=12, max_r=800))
            mission_goal += 5
            mission_progress = 0
            partners = [{'x': random.randint(50, 750), 'y': random.randint(50, 550), 'e': 0, 'a': False} for _ in range(12)]

        sponge.update(particles)
        sponge.draw(screen)

        for w in wellen[:]:
            w.update()
            if not w.alive: wellen.remove(w)
            else: w.draw(screen)

        for p in partners:
            col = HAPPY_BLUE if p['a'] else CHAOS_GREY
            pygame.draw.circle(screen, col, (p['x'], p['y']), 12, width=(0 if p['a'] else 1))
        
        for p in particles[:]:
            dx, dy = my_core['x'] - p['x'], my_core['y'] - p['y']
            dist = math.hypot(dx, dy)
            p['x'] += (dx/dist) * p['speed']; p['y'] += (dy/dist) * p['speed']
            if dist < 45:
                # Kollision: Energie verteilen
                wellen.append(ResonanzWelle(my_core['x'], my_core['y'], BOOSTER_CYAN, max_r=200))
                for target in partners:
                    if math.hypot(my_core['x']-target['x'], my_core['y']-target['y']) < 250:
                        if not target['a']:
                            target['e'] += 20 + (my_core['shield']*0.5)
                            if target['e'] >= 100:
                                target['a'] = True; total_awakened += 1; mission_progress += 1
                                wellen.append(ResonanzWelle(target['x'], target['y'], STRAWBERRY_RED))
                particles.remove(p)
            else:
                pygame.draw.circle(screen, CHAOS_GREY, (int(p['x']), int(p['y'])), 5)
        
        # Kern zeichnen
        curr_r = my_core['r'] + math.sin(my_core['pulse']) * 4
        if my_core['shield'] > 0:
            pygame.draw.circle(screen, BOOSTER_CYAN, (my_core['x'], my_core['y']), curr_r+15, width=2)
        pygame.draw.circle(screen, STRAWBERRY_RED, (my_core['x'], my_core['y']), curr_r)
        
        # UI
        txt = font_ui.render(f"Ewige Resonanz: {total_awakened} | Ziel: {mission_goal-mission_progress}", True, RADIANT_GOLD)
        screen.blit(txt, (20, 20))

        pygame.display.flip()
        clock.tick(FPS)
    pygame.quit()

if __name__ == "__main__":
    main()
