import pygame
import random
import math
import os

# ==========================================
# PROJEKT: HELD IM ERDBEERFELD (Die Wir-Maschine)
# VERSION: 0.8 - "Die kosmische Hintergrundstrahlung"
# VISION: Dein freier Wille ist das Fundament von allem.
# ==========================================

WIDTH, HEIGHT = 800, 600
FPS = 60

# Farben
STRAWBERRY_RED = (220, 20, 60)
HAPPY_BLUE = (30, 144, 255)
CHAOS_GREY = (60, 60, 70)
RADIANT_GOLD = (255, 225, 100)
SPONGE_YELLOW = (255, 255, 50)
DARK_SPACE = (5, 5, 12)
WILLPOWER_WHITE = (200, 200, 255)

pygame.init()
screen = pygame.display.set_mode((WIDTH, HEIGHT))
pygame.display.set_caption("üçì Wir-Maschine v0.8 - Kosmischer Wille")
clock = pygame.time.Clock()
font_ui = pygame.font.SysFont("Arial", 18, bold=True)

# --- Hintergrundstrahlung (Sterne des freien Willens) ---
stars = [{'x': random.randint(0, WIDTH), 'y': random.randint(0, HEIGHT), 'size': random.random()*2, 'pulse': random.random()*math.pi} for _ in range(150)]

class ResonanzWelle:
    def __init__(self, x, y, color, speed=6, max_r=400):
        self.x, self.y = x, y
        self.radius = 0
        self.max_radius = max_r
        self.alpha = 255
        self.color = color
        self.speed = speed
        self.alive = True

    def update(self):
        self.radius += self.speed
        self.alpha -= (255 / (self.max_radius / self.speed))
        if self.alpha <= 0: self.alive = False

    def draw(self, surface):
        if self.alive and self.alpha > 0:
            s = pygame.Surface((int(self.radius*2), int(self.radius*2)), pygame.SRCALPHA)
            pygame.draw.circle(s, (*self.color, int(self.alpha)), (int(self.radius), int(self.radius)), int(self.radius), width=2)
            surface.blit(s, (self.x - self.radius, self.y - self.radius))

class SpongeHelper:
    def __init__(self):
        self.active = False
        self.timer = 0
        self.x, self.y = WIDTH//2, HEIGHT//2

    def activate(self):
        self.active = True
        self.timer = 300

    def update(self, particles):
        if self.active:
            self.timer -= 1
            self.x = WIDTH//2 + math.sin(pygame.time.get_ticks()*0.005)*200
            self.y = HEIGHT//2 + math.cos(pygame.time.get_ticks()*0.005)*100
            for p in particles[:]:
                if math.hypot(self.x - p['x'], self.y - p['y']) < 120:
                    particles.remove(p)
            if self.timer <= 0: self.active = False

    def draw(self, surface):
        if self.active:
            pygame.draw.rect(surface, SPONGE_YELLOW, (self.x-30, self.y-40, 60, 80), border_radius=10)
            for i in range(8):
                pygame.draw.circle(surface, (200, 180, 0), (self.x-20+(i*5)%40, self.y-30+(i*12)%60), 4)

def main():
    running = True
    total_awakened = 0 # Hier lade_bilanz() einf√ºgen wenn gew√ºnscht
    mission_goal = 5
    mission_progress = 0
    
    my_core = {'x': WIDTH//2, 'y': HEIGHT//2, 'r': 45, 'shield': 0, 'pulse': 0}
    partners = [{'x': random.randint(50, 750), 'y': random.randint(50, 550), 'e': 0, 'a': False} for _ in range(12)]
    particles = []
    wellen = []
    sponge = SpongeHelper()
    
    while running:
        for event in pygame.event.get():
            if event.type == pygame.QUIT: running = False
            if event.type in [pygame.MOUSEBUTTONDOWN, pygame.KEYDOWN]:
                my_core['shield'] = min(100, my_core['shield'] + 30)
                wellen.append(ResonanzWelle(my_core['x'], my_core['y'], HAPPY_BLUE, speed=12))

        screen.fill(DARK_SPACE)
        
        # --- Zeichne freien Willen (Hintergrundstrahlung) ---
        for s in stars:
            s['pulse'] += 0.05
            vibration = (my_core['shield'] * 0.1) * math.sin(pygame.time.get_ticks())
            brightness = 100 + math.sin(s['pulse']) * 50 + (my_core['shield'] * 1.5)
            brightness = min(255, max(0, brightness))
            pygame.draw.circle(screen, (brightness, brightness, 255), (int(s['x'] + vibration), int(s['y'] + vibration)), s['size'])

        if random.random() < 0.05:
            particles.append({'x': random.choice([-20, 820]), 'y': random.randint(0, 600), 'speed': random.uniform(2, 5)})
        
        my_core['pulse'] += 0.05
        if my_core['shield'] > 0: my_core['shield'] -= 0.8
        
        if mission_progress >= mission_goal:
            sponge.activate()
            wellen.append(ResonanzWelle(WIDTH//2, HEIGHT//2, RADIANT_GOLD, speed=15, max_r=900))
            mission_goal += 5
            mission_progress = 0
            partners = [{'x': random.randint(50, 750), 'y': random.randint(50, 550), 'e': 0, 'a': False} for _ in range(12)]

        sponge.update(particles)
        sponge.draw(screen)

        for w in wellen[:]:
            w.update()
            if not w.alive: wellen.remove(w)
            else: w.draw(screen)

        for p in partners:
            col = HAPPY_BLUE if p['a'] else CHAOS_GREY
            pygame.draw.circle(screen, col, (p['x'], p['y']), 12, width=(0 if p['a'] else 1))
        
        for p in particles[:]:
            dx, dy = my_core['x'] - p['x'], my_core['y'] - p['y']
            dist = math.hypot(dx, dy)
            p['x'] += (dx/dist) * p['speed']; p['y'] += (dy/dist) * p['speed']
            if dist < 45:
                wellen.append(ResonanzWelle(my_core['x'], my_core['y'], BOOSTER_CYAN, max_r=250))
                for target in partners:
                    if math.hypot(my_core['x']-target['x'], my_core['y']-target['y']) < 250:
                        if not target['a']:
                            target['e'] += 25
                            if target['e'] >= 100:
                                target['a'] = True; total_awakened += 1; mission_progress += 1
                                wellen.append(ResonanzWelle(target['x'], target['y'], STRAWBERRY_RED))
                particles.remove(p)
            else:
                pygame.draw.circle(screen, CHAOS_GREY, (int(p['x']), int(p['y'])), 5)
        
        curr_r = my_core['r'] + math.sin(my_core['pulse']) * 4
        if my_core['shield'] > 0:
            pygame.draw.circle(screen, BOOSTER_CYAN, (my_core['x'], my_core['y']), curr_r+20, width=2)
        pygame.draw.circle(screen, STRAWBERRY_RED, (my_core['x'], my_core['y']), curr_r)
        
        # UI
        txt = font_ui.render(f"Ewige Resonanz: {total_awakened} | Ziel: {mission_goal-mission_progress}", True, RADIANT_GOLD)
        screen.blit(txt, (20, 20))

        pygame.display.flip()
        clock.tick(FPS)
    pygame.quit()

if __name__ == "__main__":
    main()
